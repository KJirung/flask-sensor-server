<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ğŸ“¡ ì‚¬ìš©ì ì—°ê²° ìƒíƒœ</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 10px; font-size: 14px; text-align: center; }
        th { background-color: #f5f5f5; }
        .connected { background-color: #28a745; color: white; }
        .disconnected { background-color: #dc3545; color: white; }
        .no-data, .error { background-color: gray; color: white; }
        .btn {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
        }
        .btn:disabled {
            background-color: #d6d6d6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h2>ğŸ“¡ ì‚¬ìš©ì ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§</h2>
    <button id="notifyDisconnectedButton" class="btn" onclick="notifyDisconnectedUsers()">ì—°ê²° í•´ì œëœ ì‚¬ìš©ìì—ê²Œ í‘¸ì‹œ ì•Œë¦¼ ë³´ë‚´ê¸°</button>
    <table>
        <thead>
            <tr>
                <th>Device ID</th>
                <th>ë§ˆì§€ë§‰ ìˆ˜ì‹  ì‹œê°„</th>
                <th>ìƒíƒœ</th>
            </tr>
        </thead>
        <tbody>
            {% for d in devices %}
                <tr>
                    <td>{{ d.device_id }}</td>
                    <td>{{ d.last_time }}</td>
                    <td class="{{ d.status }}">
                        {% if d.status == "connected" %}âœ… ì—°ê²°ë¨
                        {% elif d.status == "disconnected" %}âŒ ëŠê¹€
                        {% elif d.status == "no data" %}âš  ë°ì´í„° ì—†ìŒ
                        {% else %}âš  ì˜¤ë¥˜
                        {% endif %}
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
        function notifyDisconnectedUsers() {
            // í‘¸ì‹œ ì•Œë¦¼ì„ ì „ì†¡í•  ì„œë²„ API í˜¸ì¶œ
            fetch('/notify_disconnected', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message); // ì„±ê³µ ë©”ì‹œì§€ ì•Œë¦¼
            })
            .catch(error => {
                console.error('Error:', error);
                alert('í‘¸ì‹œ ì•Œë¦¼ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); // ì˜¤ë¥˜ ë©”ì‹œì§€
            });
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì—°ê²° í•´ì œëœ ì‚¬ìš©ìë§Œ ë²„íŠ¼ í™œì„±í™”
        document.addEventListener('DOMContentLoaded', function () {
            const rows = document.querySelectorAll('tbody tr');
            let disconnectedUsersExist = false;

            rows.forEach(row => {
                const statusCell = row.cells[2];
                if (statusCell && statusCell.textContent.includes('âŒ ëŠê¹€')) {
                    disconnectedUsersExist = true;
                }
            });

            const button = document.getElementById('notifyDisconnectedButton');
            button.disabled = !disconnectedUsersExist; // ì—°ê²° í•´ì œëœ ì‚¬ìš©ìê°€ ì—†ìœ¼ë©´ ë²„íŠ¼ ë¹„í™œì„±í™”
        });
    </script>
</body>
</html>
